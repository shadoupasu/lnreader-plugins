var e=this&&this.__awaiter||function(e,t,a,l){return new(a||(a=Promise))((function(n,r){function i(e){try{o(l.next(e))}catch(e){r(e)}}function u(e){try{o(l.throw(e))}catch(e){r(e)}}function o(e){var t;e.done?n(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(i,u)}o((l=l.apply(e,t||[])).next())}))},t=this&&this.__generator||function(e,t){var a,l,n,r={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]},i=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return i.next=u(0),i.throw=u(1),i.return=u(2),"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(u){return function(o){return function(u){if(a)throw new TypeError("Generator is already executing.");for(;i&&(i=0,u[0]&&(r=0)),r;)try{if(a=1,l&&(n=2&u[0]?l.return:u[0]?l.throw||((n=l.return)&&n.call(l),0):l.next)&&!(n=n.call(l,u[1])).done)return n;switch(l=0,n&&(u=[2&u[0],n.value]),u[0]){case 0:case 1:n=u;break;case 4:return r.label++,{value:u[1],done:!1};case 5:r.label++,l=u[1],u=[0];continue;case 7:u=r.ops.pop(),r.trys.pop();continue;default:if(!(n=r.trys,(n=n.length>0&&n[n.length-1])||6!==u[0]&&2!==u[0])){r=0;continue}if(3===u[0]&&(!n||u[1]>n[0]&&u[1]<n[3])){r.label=u[1];break}if(6===u[0]&&r.label<n[1]){r.label=n[1],n=u;break}if(n&&r.label<n[2]){r.label=n[2],r.ops.push(u);break}n[2]&&r.ops.pop(),r.trys.pop();continue}u=t.call(e,r)}catch(e){u=[6,e],l=0}finally{a=n=0}if(5&u[0])throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}([u,o])}}},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});var l=require("@libs/fetch"),n=require("@libs/filterInputs"),r=require("@libs/novelStatus"),i=require("htmlparser2"),u=a(require("dayjs"));var o=new(function(){function a(e){this.id=e.id,this.name=e.sourceName,this.icon="multisrc/ifreedom/".concat(e.id.toLowerCase(),"/icon.png"),this.site=e.sourceSite,this.version="1.1.0",this.filters=e.filters}return a.prototype.parseNovels=function(e){var t=this;return(0,l.fetchApi)(e).then((function(e){return e.text()})).then((function(e){var a=[],l={},n=!1,r=t.site,u=new i.Parser({onopentag:function(e,t){var a=t.class||"";"div"===e&&(a.includes("one-book-home")||a.includes("item-book-slide"))&&(n=!0),n&&("img"===e&&(l.cover=t.src,t.alt&&(l.name=t.alt)),"a"===e&&t.href&&(l.path=t.href.replace(r,""),t.title&&(l.name=t.title)))},onclosetag:function(e){"div"===e&&n&&(n=!1,l.path&&a.push(l),l={})}});return u.write(e),u.end(),a}))},a.prototype.popularNovels=function(a,l){return e(this,arguments,void 0,(function(e,a){var l,n,r=a.filters,i=a.showLatestNovels;return t(this,(function(t){return l="".concat(this.site,"/vse-knigi/?sort=").concat(i?"По дате обновления":(null===(n=null==r?void 0:r.sort)||void 0===n?void 0:n.value)||"По рейтингу"),Object.entries(r||{}).forEach((function(e){var t=e[0],a=e[1].value;Array.isArray(a)&&a.length&&(l+="&".concat(t,"[]=").concat(a.join("&".concat(t,"[]="))))})),l+="&bpage=".concat(e),[2,this.parseNovels(l)]}))}))},a.prototype.parseNovel=function(a){return e(this,void 0,void 0,(function(){var e,n,o,s,c,v,p,b,h,f,d,m,g,y,k,w;return t(this,(function(t){switch(t.label){case 0:return[4,(0,l.fetchApi)(this.site+a).then((function(e){return e.text()}))];case 1:return e=t.sent(),n={path:a,name:"",author:"",summary:"",status:r.NovelStatus.Unknown},o=[],s=[],c=this.site,v=!1,p=!1,b=!1,h=null,f=!1,d=!1,m=!1,g=!1,y=!1,k={},w=new i.Parser({onopentag:function(e,t){var a=t.class||"";if("h1"===e&&(v=!0),"div"===e&&((a.includes("block-book-slide-img")||a.includes("img-ranobe"))&&(b=!0),("descr-ranobe"===a||"active"===a&&"Описание"===t["data-name"])&&(p=!0)),p&&"span"===e&&a.includes("open-desc")){var l=t.onclick;if(l){var r=l.match(/innerHTML\s*=\s*'([\s\S]+?)'/);if(r&&r[1]){var i=r[1];i=i.replace(/&lt;br&gt;/gi,"\n").replace(/<br\s*\/?>/gi,"\n").replace(/&quot;/g,'"').replace(/&#039;/g,"'").replace(/&amp;/g,"&"),n.summary=i,p=!1}}}"img"===e&&b&&!n.cover&&(n.cover=t.src),"div"===e&&(a.includes("data-ranobe")&&(f=!0,h=null),a.includes("data-value")&&(d=!0),a.includes("book-info-list")&&(f=!0,h=null),a.includes("genreslist")&&(h="genre")),f&&("span"===e&&(a.includes("dashicons-book")&&!a.includes("book-alt")?h="genre":a.includes("admin-users")?h="author":a.includes("megaphone")&&(h="status")),"svg"===e&&(a.includes("icon-tabler-tag")?h="genre":a.includes("mood-edit")||a.includes("icon-tabler-user")?h="author":(a.includes("chart-infographic")||a.includes("megaphone"))&&(h="status"))),"div"!==e||"li-ranobe"!==a&&"chapterinfo"!==a||(m=!0),"a"===e&&m&&(k.path=t.href.replace(c,""),g=!0),"div"!==e&&"span"!==e||"li-col2-ranobe"!==a&&"timechapter"!==a||(y=!0)},ontext:function(e){var t=e.trim();if(t){if(v&&(n.name=t.replace(/®/g,"").trim()),p&&"Прочесть полностью"!==t&&(n.summary+=t+"\n"),h)(d||f&&!d)&&("author"===h?"Автор"===t||"Переводчик"===t||"Не указан"===t||t.includes("Просмотров")||(n.author=t):"status"===h?t.includes("Статус")||(n.status=function(e){var t=e.toLowerCase().trim();if(t.includes("активен")||t.includes("продолжается")||t.includes("онгоинг"))return r.NovelStatus.Ongoing;if(t.includes("завершен")||t.includes("конец")||t.includes("закончен"))return r.NovelStatus.Completed;if(t.includes("приостановлен")||t.includes("заморожен"))return r.NovelStatus.OnHiatus;return r.NovelStatus.Unknown}(t)):"genre"===h&&","!==t&&"Жанры"!==t&&s.push(t));g&&(k.name=t),y&&(k.releaseTime=function(e){void 0===e&&(e="");var t={"января":1,"февраля":2,"марта":3,"апреля":4,"мая":5,"июня":6,"июля":7,"августа":8,"сентября":9,"октября":10,"ноября":11,"декабря":12},a=/(d+)s*ч.?s*назад/,l=e.match(a);if(l){var n=parseInt(l[1],10);return(0,u.default)().subtract(n,"hour").format("LL")}if(e.includes(".")){var r=e.split("."),i=r[0],o=r[1],s=2===(null==(v=r[2])?void 0:v.length)?"20"+v:v;return(0,u.default)(s+"-"+o+"-"+i).format("LL")}if(e.includes(" ")){var c=e.split(" ");i=c[0],o=c[1];if(i&&t[o]){var v=(new Date).getFullYear();return(0,u.default)(v+"-"+t[o]+"-"+i).format("LL")}}return e||null}(t))}},onclosetag:function(e){"h1"===e&&(v=!1),"div"===e&&(p&&(p=!1),b&&(b=!1),d&&(d=!1)),"a"===e&&(g=!1),"div"!==e&&"span"!==e||!y||(y=!1,k.path&&o.push(k),k={},m=!1)}}),w.write(e),w.end(),n.genres=s.join(","),n.chapters=o.reverse(),[2,n]}}))}))},a.prototype.parseChapter=function(a){return e(this,void 0,void 0,(function(){var e,n,r,i,u,o;return t(this,(function(t){switch(t.label){case 0:return[4,(0,l.fetchApi)(this.site+a).then((function(e){return e.text()}))];case 1:return e=t.sent(),n="bookhamster"===this.id?'<div class="entry-content">':'<div class="chapter-content">',r="bookhamster"===this.id?"\x3c!-- .entry-content --\x3e":'<div class="chapter-setting">',-1===(i=e.indexOf(n))?[2,""]:(u=e.indexOf(r,i),(o=(o=e.slice(i,-1!==u?u:void 0)).replace(/<script[^>]*>[\s\S]*?<\/script>/gim,"")).includes("<img")&&(o=o.replace(/srcset="([^"]+)"/g,(function(e,t){if(!t)return e;var a=t.split(" ").filter((function(e){return e.startsWith("http")})).pop();return a?'src="'.concat(a,'"'):e}))),[2,o])}}))}))},a.prototype.searchNovels=function(a){return e(this,arguments,void 0,(function(e,a){var l;return void 0===a&&(a=1),t(this,(function(t){return l="".concat(this.site,"/vse-knigi/?searchname=").concat(encodeURIComponent(e),"&bpage=").concat(a),[2,this.parseNovels(l)]}))}))},a}())({id:"bookhamster",sourceSite:"https://bookhamster.ru",sourceName:"Bookhamster",filters:{sort:{type:n.FilterTypes.Picker,label:"Сортировка:",options:[{label:"По дате добавления",value:"По дате добавления"},{label:"По дате обновления",value:"По дате обновления"},{label:"По количеству глав",value:"По количеству глав"},{label:"По названию",value:"По названию"},{label:"По просмотрам",value:"По просмотрам"},{label:"По рейтингу",value:"По рейтингу"}],value:"По рейтингу"},status:{type:n.FilterTypes.CheckboxGroup,label:"Статус:",options:[{label:"Перевод активен",value:"Перевод активен"},{label:"Перевод приостановлен",value:"Перевод приостановлен"},{label:"Произведение завершено",value:"Произведение завершено"}],value:[]},lang:{type:n.FilterTypes.CheckboxGroup,label:"Язык:",options:[{label:"Английский",value:"Английский"},{label:"Китайский",value:"Китайский"},{label:"Корейский",value:"Корейский"},{label:"Японский",value:"Японский"}],value:[]},genre:{type:n.FilterTypes.CheckboxGroup,label:"Жанры:",options:[{label:"Боевик",value:"Боевик"},{label:"Боевые Искусства",value:"Боевые Искусства"},{label:"Вампиры",value:"Вампиры"},{label:"Виртуальный Мир",value:"Виртуальный Мир"},{label:"Гарем",value:"Гарем"},{label:"Героическое фэнтези",value:"Героическое фэнтези"},{label:"Детектив",value:"Детектив"},{label:"Дзёсэй",value:"Дзёсэй"},{label:"Драма",value:"Драма"},{label:"Игра",value:"Игра"},{label:"История",value:"История"},{label:"Киберпанк",value:"Киберпанк"},{label:"Комедия",value:"Комедия"},{label:"ЛитРПГ",value:"ЛитРПГ"},{label:"Меха",value:"Меха"},{label:"Милитари",value:"Милитари"},{label:"Мистика",value:"Мистика"},{label:"Научная Фантастика",value:"Научная Фантастика"},{label:"Повседневность",value:"Повседневность"},{label:"Постапокалипсис",value:"Постапокалипсис"},{label:"Приключения",value:"Приключения"},{label:"Психология",value:"Психология"},{label:"Романтика",value:"Романтика"},{label:"Сверхъестественное",value:"Сверхъестественное"},{label:"Сёдзё",value:"Сёдзё"},{label:"Сёнэн",value:"Сёнэн"},{label:"Сёнэн-ай",value:"Сёнэн-ай"},{label:"Спорт",value:"Спорт"},{label:"Сэйнэн",value:"Сэйнэн"},{label:"Сюаньхуа",value:"Сюаньхуа"},{label:"Трагедия",value:"Трагедия"},{label:"Триллер",value:"Триллер"},{label:"Ужасы",value:"Ужасы"},{label:"Фантастика",value:"Фантастика"},{label:"Фэнтези",value:"Фэнтези"},{label:"Школьная жизнь",value:"Школьная жизнь"},{label:"Экшн",value:"Экшн"},{label:"Эротика",value:"Эротика"},{label:"Этти",value:"Этти"},{label:"Яой",value:"Яой"},{label:"Adult",value:"Adult"},{label:"Mature",value:"Mature"},{label:"Xianxia",value:"Xianxia"},{label:"Xuanhuan",value:"Xuanhuan"}],value:[]}}});exports.default=o;